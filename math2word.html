<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuy·ªÉn To√°n h·ªçc sang DOCX (B·∫£n ·ªïn ƒë·ªãnh)</title>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; background-color: #f4f4f9; margin: 0; }
        .container { width: 100%; max-width: 800px; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; margin-bottom: 20px; }
        textarea { width: 100%; height: 250px; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; line-height: 1.6; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 20px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
    </style>
    
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // B·ªçc to√†n b·ªô logic c·ªßa ch√∫ng ta v√†o m·ªôt h√†m, v√≠ d·ª• l√† main()
        function main() {
            const { Document, Packer, Paragraph, TextRun, ImageRun, AlignmentType } = docx;

            const downloadBtn = document.getElementById('downloadBtn');
            const mathInput = document.getElementById('mathInput');
            const fileNameInput = document.getElementById('fileName');
            const renderDiv = document.getElementById('render-hidden');

            function svgStringToBase64(svgString) {
                return new Promise(resolve => {
                    const blob = new Blob([svgString], { type: 'image/svg+xml' });
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64data = reader.result.split(',')[1];
                        resolve(base64data);
                    };
                    reader.readAsDataURL(blob);
                });
            }

            async function renderMathToImage(latex) {
                renderDiv.innerHTML = latex;
                await MathJax.typesetPromise([renderDiv]);
                const svgElement = renderDiv.querySelector('svg');
                if (!svgElement) return null;

                svgElement.setAttribute("xmlns", "http://www.w3.org/2000/svg");
                
                const serializer = new XMLSerializer();
                const svgString = serializer.serializeToString(svgElement);
                
                const width = parseFloat(svgElement.getAttribute('width').replace('ex', '')) * 8.5;
                const height = parseFloat(svgElement.getAttribute('height').replace('ex', '')) * 8.5;

                const base64Image = await svgStringToBase64(svgString);

                return {
                    data: base64Image,
                    width,
                    height,
                };
            }

            downloadBtn.addEventListener('click', async () => {
                const fullText = mathInput.value;
                if (!fullText.trim()) {
                    alert("Vui l√≤ng nh·∫≠p n·ªôi dung.");
                    return;
                }

                downloadBtn.disabled = true;
                downloadBtn.textContent = '‚è≥ ƒêang x·ª≠ l√Ω...';

                try {
                    const docParagraphs = [];
                    const regex = /(\$\$?[\s\S]+?\$\$?)/g;
                    const lines = fullText.split('\n');

                    for (const line of lines) {
                        if (!line.trim()) {
                            docParagraphs.push(new Paragraph({ children: [new TextRun("")] }));
                            continue;
                        }

                        const children = []; 
                        const parts = line.split(regex).filter(part => part);

                        for (const part of parts) {
                            if (part.match(regex)) {
                                const image = await renderMathToImage(part);
                                if (image) {
                                    children.push(new ImageRun({
                                        data: image.data, 
                                        transformation: { width: image.width, height: image.height },
                                    }));
                                }
                            } else {
                                children.push(new TextRun(part));
                            }
                        }

                        let alignment = AlignmentType.LEFT;
                        const trimmedLine = line.trim();
                        if (trimmedLine.startsWith('$$') && trimmedLine.endsWith('$$') && parts.length === 1) {
                            alignment = AlignmentType.CENTER;
                        }
                        
                        docParagraphs.push(new Paragraph({ children, alignment }));
                    }

                    const doc = new Document({ sections: [{ children: docParagraphs }] });
                    const blob = await Packer.toBlob(doc);
                    saveAs(blob, fileNameInput.value || 'document.docx');

                } catch (error) {
                    console.error("L·ªói khi t·∫°o file DOCX:", error);
                    alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file. Vui l√≤ng ki·ªÉm tra l·∫°i Console (F12) ƒë·ªÉ bi·∫øt chi ti·∫øt.");
                } finally {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'üì• T·∫£i xu·ªëng file .docx';
                }
            });
        }

        // C·∫•u h√¨nh cho MathJax bi·∫øt ph·∫£i l√†m g√¨ khi n√≥ s·∫µn s√†ng
        MathJax = {
            loader: {load: ['input/tex', 'output/svg']},
            svg: {fontCache: 'global'},
            startup: {
                // Khi MathJax s·∫µn s√†ng, n√≥ s·∫Ω g·ªçi h√†m n√†y
                ready: () => {
                    console.log('MathJax is ready.');
                    MathJax.startup.defaultReady();
                    // B√¢y gi·ªù m·ªõi l√† l√∫c an to√†n ƒë·ªÉ ch·∫°y code c·ªßa ch√∫ng ta
                    main();
                }
            }
        };
    </script>
    
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>
<body>
    <div class="container">
        <h2>C√¥ng c·ª• Download DOCX (B·∫£n ·ªïn ƒë·ªãnh)</h2>
        <textarea id="mathInput" placeholder="0000Nh·∫≠p ƒë·ªÅ b√†i t·∫°i ƒë√¢y...&#10;D√πng $...$ cho c√¥ng th·ª©c inline, v√≠ d·ª•: ph∆∞∆°ng tr√¨nh $x^2 - 2x + 1 = 0$.&#10;D√πng $$...$$ cho c√¥ng th·ª©c ri√™ng m·ªôt d√≤ng v√† s·∫Ω ƒë∆∞·ª£c cƒÉn gi·ªØa.&#10;$$E = mc^2$$"></textarea>
        <input type="text" id="fileName" value="baitap_toan.docx" placeholder="T√™n file...">
        <button id="downloadBtn">üì• T·∫£i xu·ªëng file .docx</button>
    </div>

    <div id="render-hidden" style="position: absolute; visibility: hidden; left: -9999px;"></div>
</body>
</html>

